---
phase: 08-web-brief-preview-zoning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/section-zoning.ts
  - src/types/web-brief.ts
  - src/lib/section-id.ts
  - src/lib/section-registry.ts
  - src/components/layouts/LayoutPlaceholder.tsx
  - src/features/clients/components/WebBriefDocumentContent.tsx
  - src/features/clients/components/WebBriefView.tsx
autonomous: true
requirements:
  - WBPZ-01
  - WBPZ-02
  - WBPZ-03

must_haves:
  truths:
    - "Every section has a stable UUID id that persists across reorders"
    - "Legacy documents without section ids get ids assigned on load"
    - "Unknown layout roles show a visible placeholder instead of rendering nothing"
    - "Similar roles (e.g. 'testimonials' -> 'testimonial') are matched to existing layouts before showing placeholder"
  artifacts:
    - path: "src/lib/section-id.ts"
      provides: "generateSectionId() and ensureSectionIds() utilities"
      exports: ["generateSectionId", "ensureSectionIds"]
    - path: "src/components/layouts/LayoutPlaceholder.tsx"
      provides: "Fallback placeholder for unknown layout roles"
      contains: "Layout inexistant"
    - path: "src/lib/section-registry.ts"
      provides: "getLayoutForRoleWithFallback with similarity matching"
      exports: ["getLayoutForRoleWithFallback", "ROLE_SIMILARITY_MAP"]
  key_links:
    - from: "src/features/clients/components/WebBriefDocumentContent.tsx"
      to: "src/lib/section-id.ts"
      via: "ensureSectionIds called on parsed webBriefData"
      pattern: "ensureSectionIds"
    - from: "src/features/clients/components/WebBriefView.tsx"
      to: "src/lib/section-registry.ts"
      via: "getLayoutForRoleWithFallback replaces getLayoutForRole"
      pattern: "getLayoutForRoleWithFallback"
    - from: "src/features/clients/components/WebBriefView.tsx"
      to: "src/components/layouts/LayoutPlaceholder.tsx"
      via: "rendered when getLayoutForRoleWithFallback returns null layout"
      pattern: "LayoutPlaceholder"
---

<objective>
Migrate section identity from array-index to UUID and implement intelligent layout matching with visible fallback for unknown roles.

Purpose: This is the foundation for all Phase 8 work. UUID-based section identity is a prerequisite for drag & drop (Plan 02) and per-section edit state (Plan 03). Layout fallback makes the preview robust against unknown roles from AI agents.

Output: section-id.ts utility, LayoutPlaceholder component, enhanced section-registry with similarity matching, types updated with id field, WebBriefView and WebBriefDocumentContent migrated from index-based to id-based section identity.
</objective>

<execution_context>
@/Users/jeremyhervo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jeremyhervo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-web-brief-preview-zoning/08-RESEARCH.md

@src/types/section-zoning.ts
@src/types/web-brief.ts
@src/lib/section-registry.ts
@src/features/clients/components/WebBriefView.tsx
@src/features/clients/components/WebBriefDocumentContent.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create section-id utility, update types, enhance section-registry with fallback</name>
  <files>
    src/lib/section-id.ts
    src/types/section-zoning.ts
    src/types/web-brief.ts
    src/lib/section-registry.ts
    src/components/layouts/LayoutPlaceholder.tsx
  </files>
  <action>
1. Create `src/lib/section-id.ts`:
   - Export `generateSectionId(): string` using `crypto.randomUUID()` (native Node 18+). Add a Math.random fallback for safety but it should never trigger in Next.js 16.
   - Export `ensureSectionIds<T extends { id?: string }>(sections: T[]): (T & { id: string })[]` — maps over sections, adds `id: generateSectionId()` to any section missing an `id` field.

2. Update `src/types/section-zoning.ts`:
   - Add `id?: string` to `ZonedSection` interface (optional for backward compat with agent output).

3. Update `src/types/web-brief.ts`:
   - Add `id?: string` to `HomepageSection` interface (optional for backward compat).

4. Enhance `src/lib/section-registry.ts`:
   - Add a `ROLE_SIMILARITY_MAP: Record<string, SectionRole>` mapping common AI role aliases to existing roles:
     - about -> value_proposition
     - team -> social_proof
     - our_services -> services_teaser
     - service_list -> services_teaser
     - testimonials -> testimonial
     - reviews -> testimonial
     - stats -> features
     - numbers -> features
     - process -> features
     - methodology -> features
     - portfolio -> social_proof
     - case_studies -> social_proof
     - contact -> contact_form
     - cta -> cta_final
     - call_to_action -> cta_final
   - Export `getLayoutForRoleWithFallback(role: string): { layout: ComponentType<LayoutComponentProps> | null; matched: SectionRole | null; isExact: boolean }`:
     - First try exact match in SECTION_TO_LAYOUT.
     - Then try `role.toLowerCase()` in ROLE_SIMILARITY_MAP -> get the mapped SectionRole -> get layout.
     - If nothing matches, return `{ layout: null, matched: null, isExact: false }`.
   - Keep the existing `getLayoutForRole` and `isValidSectionRole` exports for backward compat.

5. Create `src/components/layouts/LayoutPlaceholder.tsx`:
   - `'use client'` component.
   - Props: `{ role: string; matchedRole?: string; onGenerate?: () => void }`.
   - Render a dashed border container (min-h-[200px]) with:
     - Role name in monospace text.
     - "Layout inexistant" message.
     - If `matchedRole` provided, show "Role similaire disponible : {matchedRole}".
     - If `onGenerate` provided, show a "Generer ce layout" button.
   - Use project CSS variables: `var(--border-medium)`, `var(--text-muted)`, `var(--text-primary)`, `var(--text-secondary)`, `var(--accent-cyan)`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes without errors.
    - `section-id.ts` exports `generateSectionId` and `ensureSectionIds`.
    - `section-registry.ts` exports `getLayoutForRoleWithFallback` and `ROLE_SIMILARITY_MAP`.
    - `LayoutPlaceholder.tsx` exists and renders correctly.
  </verify>
  <done>
    - ZonedSection and HomepageSection types include optional `id` field.
    - section-id utility generates UUIDs and can backfill legacy sections.
    - section-registry has intelligent matching (exact -> similarity -> null).
    - LayoutPlaceholder component renders a visible fallback for unknown roles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate WebBriefDocumentContent and WebBriefView from index-based to UUID-based section identity</name>
  <files>
    src/features/clients/components/WebBriefDocumentContent.tsx
    src/features/clients/components/WebBriefView.tsx
  </files>
  <action>
1. In `WebBriefDocumentContent.tsx`:
   - Import `ensureSectionIds` from `@/lib/section-id`.
   - After parsing `webBriefData` from JSON (around line 62-67), apply migration:
     ```
     const migratedData = {
       ...parsed,
       homepage: { ...parsed.homepage, sections: ensureSectionIds(parsed.homepage.sections ?? []) },
       pages: Object.fromEntries(
         Object.entries(parsed.pages ?? {}).map(([slug, page]) => [
           slug, { ...page, sections: ensureSectionIds(page.sections ?? []) }
         ])
       ),
     };
     webBriefData = migratedData;
     ```
   - Change all callback signatures from `sectionIndex: number` to `sectionId: string`:
     - `handleSectionRewrite(sectionIndex, customPrompt)` -> find section by id in sorted array
     - `handleSectionYam(sectionIndex)` -> find section by id
     - `handlePageSectionRewrite(pageSlug, sectionIndex, ...)` -> find by id
     - `handlePageSectionYam(pageSlug, sectionIndex)` -> find by id
     - `handleSectionContentChange(sectionIndex, patch)` -> find by id
     - `handlePageSectionContentChange(pageSlug, sectionIndex, patch)` -> find by id
   - When updating document content after rewrite, locate section by `id` (not by sorted array position).

2. In `WebBriefView.tsx`:
   - Update prop types: all `sectionIndex: number` params become `sectionId: string`.
   - Replace state variables:
     - `rewritingIndex: number | null` -> `rewritingId: string | null`
     - `rewritingPageSlug` stays as-is (it identifies the page, not the section)
     - `promptForIndex: number | null` -> `promptForSectionId: string | null`
     - `promptForPageSlug` stays as-is
   - In section rendering (`currentSections.map`), use `section.id` as React key (instead of `${section.role}-${section.order}`).
   - Replace `getLayoutForRole` calls with `getLayoutForRoleWithFallback`:
     - If `result.layout` is not null, render it.
     - If `result.layout` is null, render `LayoutPlaceholder` with `role={section.role}` and `matchedRole={result.matched ?? undefined}`.
   - Update all click handlers that pass `sectionIndex` to pass `section.id` instead.
   - Ensure the `Draggable` key in PreviewSectionWithEdit uses `section.id` as the `draggableId` (prepares for Plan 02 DnD).
  </action>
  <verify>
    - `npx tsc --noEmit` passes.
    - `npm run build` succeeds.
    - Open a web-brief document in the app: sections render with UUID-based keys. Unknown roles show the LayoutPlaceholder.
    - Rewriting a section works correctly (targets the right section by id, not stale index).
  </verify>
  <done>
    - All section identity is UUID-based throughout WebBriefView and WebBriefDocumentContent.
    - No more `sectionIndex: number` in any web-brief component prop or handler.
    - Unknown roles render LayoutPlaceholder instead of nothing.
    - Legacy documents without section ids get ids assigned transparently on load.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero type errors
2. `npm run build` — successful build
3. Open a web-brief document: all sections render, no blank sections for unknown roles
4. Edit/rewrite a section: targets the correct section (verify by checking content changes)
5. Load a legacy document (no id fields in JSON): sections get UUIDs assigned and display correctly
</verification>

<success_criteria>
- Section identity is UUID-based throughout the web-brief preview system.
- Unknown roles show a visible fallback placeholder instead of rendering nothing.
- Similar roles are matched to existing layouts (e.g., "testimonials" -> testimonial layout).
- All existing functionality (view, rewrite, edit) continues to work with the new id-based identity.
</success_criteria>

<output>
After completion, create `.planning/phases/08-web-brief-preview-zoning/08-01-SUMMARY.md`
</output>
