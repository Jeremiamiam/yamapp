---
phase: 08-web-brief-preview-zoning
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/layouts/LayoutNavbar.tsx
  - src/features/clients/components/WebBriefView.tsx
  - src/features/clients/components/WebBriefDocumentContent.tsx
  - package.json
autonomous: true
requirements:
  - WBPZ-04
  - WBPZ-05
  - WBPZ-06
  - WBPZ-07

must_haves:
  truths:
    - "Nav items with children render a dropdown submenu in the preview navbar"
    - "Children page slugs appear as navigable tabs in the preview"
    - "User can delete a page (nav entry + page data + sections removed)"
    - "User can reorder sections within a page by dragging them"
    - "User can add a new section to a page"
    - "User can delete an individual section from a page"
  artifacts:
    - path: "src/components/layouts/LayoutNavbar.tsx"
      provides: "Submenu dropdown rendering for nav items with children"
      contains: "children"
    - path: "src/features/clients/components/WebBriefView.tsx"
      provides: "DnD section reorder, section add/delete, page delete, submenu tab flattening"
      contains: "DragDropContext"
  key_links:
    - from: "src/features/clients/components/WebBriefView.tsx"
      to: "@hello-pangea/dnd"
      via: "DragDropContext + Droppable + Draggable wrapping section list"
      pattern: "DragDropContext"
    - from: "src/components/layouts/LayoutNavbar.tsx"
      to: "src/features/clients/components/WebBriefView.tsx"
      via: "onNavClick callback for children items navigates to child tab"
      pattern: "onNavClick"
    - from: "src/features/clients/components/WebBriefDocumentContent.tsx"
      to: "src/features/clients/components/WebBriefView.tsx"
      via: "onDeletePage, onDeleteSection, onAddSection, onReorderSections callbacks"
      pattern: "onDeletePage|onDeleteSection|onAddSection|onReorderSections"
---

<objective>
Add navigation submenus, page deletion, section drag & drop reorder, and section add/delete operations.

Purpose: Users need to manipulate the web-brief structure (reorder sections, add/remove sections and pages) and see hierarchical navigation rendered properly. This makes the preview interactive and editable beyond just content.

Output: LayoutNavbar with submenu support, WebBriefView with DnD section reorder and CRUD operations, WebBriefDocumentContent wired to persist structural changes.
</objective>

<execution_context>
@/Users/jeremyhervo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jeremyhervo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-web-brief-preview-zoning/08-RESEARCH.md
@.planning/phases/08-web-brief-preview-zoning/08-01-SUMMARY.md

@src/components/layouts/LayoutNavbar.tsx
@src/features/clients/components/WebBriefView.tsx
@src/features/clients/components/WebBriefDocumentContent.tsx
@src/types/web-brief.ts
@src/lib/section-id.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Submenu rendering in LayoutNavbar + flatten children into pageTabs + page delete</name>
  <files>
    src/components/layouts/LayoutNavbar.tsx
    src/features/clients/components/WebBriefView.tsx
    src/features/clients/components/WebBriefDocumentContent.tsx
  </files>
  <action>
1. Update `LayoutNavbar.tsx`:
   - The component already receives `navigation` as a prop (via `content`). Check how it currently renders nav items.
   - For each primary nav item that has `children` array (non-empty):
     - Render a parent item with a dropdown indicator (small chevron).
     - On hover or click, show a dropdown with child items.
     - Each child item triggers `onNavClick(child.slug)` when clicked.
     - Style the dropdown with project CSS vars: `var(--bg-secondary)`, `var(--border-subtle)`, `var(--text-primary)`.
   - Items without children render as before (flat link with `onNavClick`).

2. Flatten children into `pageTabs` in `WebBriefView.tsx`:
   - In the `pageTabs` construction (around line 67-80), also iterate `primaryNav` children:
     ```
     const childTabs: PageTab[] = primaryNav.flatMap(item =>
       (item.children ?? []).map(child => ({ label: child.page, slug: child.slug, isHomepage: false }))
     );
     ```
   - Append `childTabs` to the existing pageTabs array (after primaryNav tabs, before addedPages tabs).
   - This ensures clicking a child nav item navigates to a real tab in the preview.

3. Add page delete operation:
   - In `WebBriefView.tsx`, add a delete button (trash icon) next to each page tab (visible only in edit mode).
   - The delete button calls `onDeletePage(slug)` prop callback.
   - In `WebBriefDocumentContent.tsx`, implement `handleDeletePage(slug: string)`:
     - Remove the page from `data.pages[slug]`.
     - Remove from `data.architecture.navigation.primary` (filter by slug).
     - Remove from `data.architecture.navigation.added_pages` (filter by slug).
     - Also check `data.architecture.navigation.footer_only` (filter by slug).
     - Also remove from children arrays of primary nav items.
     - Persist by calling `updateDocument` with stringified updated data.
     - If the deleted page was the active tab, switch to homepage tab.
   - Add confirmation before delete: simple `window.confirm('Supprimer cette page et toutes ses sections ?')`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes.
    - LayoutNavbar renders dropdown submenus for nav items with children.
    - Clicking a child nav item switches to the correct page tab.
    - Delete button appears in edit mode on page tabs.
    - Deleting a page removes it from nav, tabs, and page data.
  </verify>
  <done>
    - Nav items with children show dropdown submenus in the preview navbar.
    - Children pages are navigable as tabs.
    - Pages can be deleted with full cleanup (nav + data + sections).
  </done>
</task>

<task type="auto">
  <name>Task 2: Section drag & drop reorder + section add/delete</name>
  <files>
    src/features/clients/components/WebBriefView.tsx
    src/features/clients/components/WebBriefDocumentContent.tsx
    package.json
  </files>
  <action>
1. Install `@hello-pangea/dnd`:
   ```bash
   npm install @hello-pangea/dnd
   ```

2. In `WebBriefView.tsx`, wrap the section list with DnD (only in edit mode):
   - Import `DragDropContext, Droppable, Draggable` from `@hello-pangea/dnd`.
   - Create a `reorder<T>(list: T[], startIndex: number, endIndex: number): T[]` utility.
   - Wrap the section rendering area with `<DragDropContext onDragEnd={handleDragEnd}>`.
   - Each section gets `<Draggable draggableId={section.id} index={index}>`.
   - `handleDragEnd`: reorder the sections array, update `order` field on each (i+1), call `onReorderSections(pageSlug, reorderedSections)` callback.
   - Add a drag handle icon (6 dots / grip icon) to each section card, visible only in edit mode.
   - When NOT in edit mode, render sections without DnD wrapper (no drag handles, no Droppable).
   - Note: `section.id` from Plan 01 is the `draggableId` (stable UUID).

3. Add section add/delete operations in `WebBriefView.tsx`:
   - Add a "+" button at the bottom of the section list (edit mode only) that calls `onAddSection(pageSlug)`.
   - Add a delete button (small trash icon) on each section card (edit mode only) that calls `onDeleteSection(pageSlug, sectionId)`.
   - Confirm before section delete: `window.confirm('Supprimer cette section ?')`.

4. In `WebBriefDocumentContent.tsx`, implement the structural callbacks:
   - `handleReorderSections(pageSlug: string | null, reorderedSections: Section[])`:
     - If pageSlug is null (homepage): update `data.homepage.sections`.
     - Else: update `data.pages[pageSlug].sections`.
     - Persist via `updateDocument`.
   - `handleAddSection(pageSlug: string | null)`:
     - Create a new section with `id: generateSectionId()`, `role: 'hero'` (default), `order: lastOrder + 1`, `intent: ''`, `content: { title: 'Nouvelle section', text: '' }`.
     - Append to the page's sections array.
     - Persist via `updateDocument`.
   - `handleDeleteSection(pageSlug: string | null, sectionId: string)`:
     - Filter out the section by id from the page's sections array.
     - Re-compute `order` for remaining sections.
     - Persist via `updateDocument`.
   - Pass these callbacks to `WebBriefView` as props.

5. Test @hello-pangea/dnd with React 19:
   - If StrictMode causes issues (drag handles not responding), wrap `DragDropContext` with a dynamic import or add `resetServerContext()` call. As per research, check for known issues and apply workaround if needed.
  </action>
  <verify>
    - `npm install` succeeds (no peer dep conflicts with React 19).
    - `npx tsc --noEmit` passes.
    - `npm run build` succeeds.
    - In edit mode: sections show drag handles and can be reordered by dragging.
    - Drag reorder updates the `order` field and persists correctly.
    - "+" button adds a new default section at the bottom.
    - Trash icon on sections deletes the section after confirmation.
  </verify>
  <done>
    - Sections are reorderable via drag & drop in edit mode.
    - Sections can be added (default empty section) and deleted.
    - All structural changes persist to the document store.
    - @hello-pangea/dnd installed and working with React 19.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero type errors
2. `npm run build` — successful build
3. Preview with nav children: dropdown submenus appear, clicking child navigates to correct tab
4. Delete a page in edit mode: page removed from nav, tabs, and data
5. Drag a section to reorder: sections reorder visually and persist
6. Add a section via "+" button: new default section appears at bottom
7. Delete a section: section removed after confirmation, remaining sections re-ordered
</verification>

<success_criteria>
- Navigation renders hierarchical submenus for items with children.
- Pages can be fully deleted (nav + data + sections).
- Sections can be reordered via drag & drop within a page.
- Sections can be added and deleted individually.
- All structural changes persist to the document.
</success_criteria>

<output>
After completion, create `.planning/phases/08-web-brief-preview-zoning/08-02-SUMMARY.md`
</output>
