---
phase: 10-layout-gallery-variants
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/layout-gallery/components/LayoutGallery.tsx
  - src/features/layout-gallery/components/LayoutGalleryGrid.tsx
  - src/features/layout-gallery/components/LayoutCard.tsx
  - src/features/clients/components/SectionDrawer.tsx
  - src/features/wiki/components/WikiView.tsx
  - src/features/wiki/wiki-data.ts
autonomous: true
requirements:
  - LGAL-01
  - LGAL-02
  - LGAL-03
  - LGAL-04
  - LGAL-05
  - LGAL-06
  - LGAL-10

must_haves:
  truths:
    - "User sees a gallery grid showing all standard and custom layouts with scaled live previews"
    - "User can open the gallery from the wiki view via a dedicated button"
    - "User can open the gallery from the LayoutPicker in SectionDrawer via a gallery icon button"
    - "User can create a variant of any layout from the gallery (triggers generate-layout API)"
    - "User can select a layout/variant in the gallery and it propagates back to the section being edited"
    - "Wiki shows a new Layout Gallery feature entry"
  artifacts:
    - path: "src/features/layout-gallery/components/LayoutGallery.tsx"
      provides: "Full-screen modal gallery component"
      min_lines: 80
    - path: "src/features/layout-gallery/components/LayoutGalleryGrid.tsx"
      provides: "Grid of layout cards grouped by standard/custom"
      min_lines: 40
    - path: "src/features/layout-gallery/components/LayoutCard.tsx"
      provides: "Single layout preview card with scaled rendering"
      min_lines: 30
  key_links:
    - from: "src/features/wiki/components/WikiView.tsx"
      to: "LayoutGallery"
      via: "useState galleryOpen + button onClick"
      pattern: "setGalleryOpen\\(true\\)"
    - from: "src/features/clients/components/SectionDrawer.tsx"
      to: "LayoutGallery"
      via: "onOpenGallery prop on LayoutPicker"
      pattern: "onOpenGallery"
    - from: "LayoutGallery"
      to: "/api/generate-layout"
      via: "fetch POST for variant creation"
      pattern: "fetch.*generate-layout"
    - from: "LayoutGallery"
      to: "SectionDrawer"
      via: "onSelectRole callback"
      pattern: "onSelectRole"
---

<objective>
Build the Layout Gallery as a full-screen modal with scaled live previews of all layouts (standard + custom), variant creation via the existing generate-layout API, dual entry points from WikiView and SectionDrawer LayoutPicker, and wiki documentation.

Purpose: Give users a visual way to browse all available layouts, create variants without overwriting base layouts, and assign layouts to sections — the main UI surface for Phase 10.

Output: LayoutGallery modal component, LayoutGalleryGrid, LayoutCard, integration into WikiView and SectionDrawer, wiki entry.
</objective>

<execution_context>
@/Users/jeremyhervo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jeremyhervo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-layout-gallery-variants/10-RESEARCH.md

# Key source files
@src/lib/section-registry.ts
@src/lib/custom-layouts.ts
@src/app/api/generate-layout/route.ts
@src/features/clients/components/SectionDrawer.tsx
@src/features/wiki/components/WikiView.tsx
@src/features/wiki/wiki-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: LayoutGallery modal + LayoutCard + LayoutGalleryGrid</name>
  <files>
    src/features/layout-gallery/components/LayoutGallery.tsx
    src/features/layout-gallery/components/LayoutGalleryGrid.tsx
    src/features/layout-gallery/components/LayoutCard.tsx
  </files>
  <action>
Create three new files in `src/features/layout-gallery/components/`:

**LayoutCard.tsx:**
- Props: `{ role: string; label: string; group: 'standard' | 'custom'; isSelected: boolean; onClick: () => void }`
- Render the actual layout component at reduced scale using CSS transform:
  - Container: `overflow-hidden rounded-lg` with fixed height (160px), `position: relative`
  - Inner div: `position: absolute; top: 0; left: 0; width: 454%; height: 454%; transform: scale(0.22); transform-origin: top left; pointer-events: none`
  - Wrap the inner div in a `data-theme="light"` div so layouts render with light CSS variables (layouts are client-facing, gallery is dark)
  - Use `getLayoutForRoleWithFallback(role)` from `section-registry.ts` to get the component
  - If no layout found, render `LayoutPlaceholder` (import from `@/components/layouts/LayoutPlaceholder` — check if it exists, if not render a simple fallback div with role name)
  - Pass empty `content={{}}` — layouts have built-in default content
- Below the preview: show `label` (text-sm font-medium) and `group` badge (text-[10px], colored: standard=cyan, custom=violet)
- Selected state: ring-2 ring-[var(--accent-cyan)]

**LayoutGalleryGrid.tsx:**
- Props: `{ onSelectLayout: (role: string) => void; selectedRole: string | null; onCreateVariant: (baseRole: string) => void }`
- Call `getAvailableLayouts()` from `section-registry.ts` to get all layouts
- Group them: render "Standard" group header then standard cards, then "Custom" group header then custom cards
- Grid: `grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4`
- Each card: `LayoutCard` with onClick setting selectedRole
- Below each card (on hover or always for custom): show a small "Créer variante" button (text-[10px], accent-violet)

**LayoutGallery.tsx:**
- Props: `{ isOpen: boolean; onClose: () => void; initialRole?: string; onSelectRole?: (role: string) => void }`
- Full-screen overlay: `fixed inset-0 z-[100] bg-[var(--bg-primary)]/95 backdrop-blur-sm`
- Header bar: title "Galerie de Layouts" (text-lg font-bold), close button (X icon), and if `onSelectRole` is provided, a "Appliquer" button (accent-cyan, disabled if no selection)
- Body: scrollable container with `LayoutGalleryGrid`
- State: `selectedRole` (local useState, initialized from `initialRole`)
- "Créer variante" flow: when user clicks "Créer variante" on a card:
  1. Show a small inline prompt input asking for variant name (e.g., "hero_split" — base role + underscore + suffix)
  2. On confirm, call `fetch('/api/generate-layout', { method: 'POST', body: JSON.stringify({ role: variantRole }) })`
  3. On success, show a brief success toast (simple div with setTimeout auto-dismiss) and call `router.refresh()` (import from `next/navigation`) to pick up new registry
- "Appliquer" button: calls `onSelectRole(selectedRole)` then `onClose()`
- Escape key closes the gallery
- All state is local useState — no Zustand

IMPORTANT: Use only CSS variables from the project (var(--bg-primary), var(--text-primary), var(--accent-cyan), etc.). Use Tailwind for layout. All UI text in French.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors in the new files.
Verify the three files exist in `src/features/layout-gallery/components/`.
  </verify>
  <done>
LayoutGallery renders as a full-screen modal, shows all layouts in a grid with scaled previews, supports variant creation via generate-layout API, and provides layout selection with "Appliquer" button.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire gallery entry points (WikiView + SectionDrawer) and update wiki data</name>
  <files>
    src/features/wiki/components/WikiView.tsx
    src/features/wiki/wiki-data.ts
    src/features/clients/components/SectionDrawer.tsx
  </files>
  <action>
**WikiView.tsx:**
- Add `import { LayoutGallery } from '@/features/layout-gallery/components/LayoutGallery'`
- Add `const [galleryOpen, setGalleryOpen] = useState(false)` state
- In the wiki content area, add a new section/button for "Galerie de Layouts" — a card or button with a grid icon (use inline SVG, 4-square grid pattern) and label "Ouvrir la galerie de layouts"
- On click: `setGalleryOpen(true)`
- Render: `{galleryOpen && <LayoutGallery isOpen onClose={() => setGalleryOpen(false)} />}`
- Add `'gallery'` to `ICON_MAP` if needed (or use inline icon directly)

**SectionDrawer.tsx — LayoutPicker modification:**
- Add `onOpenGallery?: () => void` prop to the `LayoutPicker` internal component
- Add a small button immediately after the existing dropdown trigger button in the LayoutPicker JSX:
  ```
  {onOpenGallery && (
    <button type="button" onClick={onOpenGallery}
      className="p-1 rounded text-[var(--text-muted)] hover:text-[var(--accent-cyan)] hover:bg-[var(--accent-cyan)]/10 transition-colors"
      title="Galerie de layouts">
      {/* 4-square grid SVG icon */}
    </button>
  )}
  ```
- In the `SectionDrawer` main component:
  - Add `const [galleryOpen, setGalleryOpen] = useState(false)` and `const [galleryContextSectionId, setGalleryContextSectionId] = useState<string | null>(null)`
  - Pass `onOpenGallery={() => { setGalleryContextSectionId(editingSectionId); setGalleryOpen(true); }}` to the LayoutPicker
  - Render LayoutGallery at the bottom of the component:
    ```
    {galleryOpen && (
      <LayoutGallery
        isOpen
        onClose={() => setGalleryOpen(false)}
        initialRole={editingSection?.role}
        onSelectRole={(role) => {
          if (galleryContextSectionId && onRoleChange) {
            onRoleChange(galleryContextSectionId, role);
          }
        }}
      />
    )}
    ```

**wiki-data.ts:**
- Add a new entry to `FEATURE_SECTIONS` array:
  ```
  {
    id: 'layout-gallery',
    title: 'Galerie de Layouts',
    color: 'var(--accent-violet)',
    icon: 'layout-grid',
    description: 'Galerie visuelle de tous les layouts disponibles (standard + custom). Permet de créer des variantes, éditer le code via IA ou manuellement, et appliquer un layout à une section.',
    actions: [
      'Parcourir tous les layouts avec aperçu en miniature',
      'Créer une variante d\'un layout existant',
      'Appliquer un layout à la section en cours d\'édition',
      'Accès depuis le wiki ou le LayoutPicker du SectionDrawer',
    ],
  }
  ```
- If `ICON_MAP` in WikiView.tsx needs a `'layout-grid'` entry, add one (a 2x2 grid icon using lucide-style SVG or existing icon pattern).

IMPORTANT: The LayoutGallery import must use the exact path `@/features/layout-gallery/components/LayoutGallery`. Preserve all existing functionality in SectionDrawer and WikiView — only ADD, never remove.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Grep for "galleryOpen" in WikiView.tsx and SectionDrawer.tsx — both must have the state.
Grep for "layout-gallery" in wiki-data.ts — entry must exist.
  </verify>
  <done>
Gallery opens from WikiView via a "Galerie de Layouts" button. Gallery opens from SectionDrawer LayoutPicker via a grid icon button next to the dropdown. Selecting a layout in the gallery propagates back via onSelectRole → onRoleChange to update the section. Wiki documents the new feature.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` completes successfully (or `next build`)
3. Three new files exist: LayoutGallery.tsx, LayoutGalleryGrid.tsx, LayoutCard.tsx
4. WikiView.tsx contains galleryOpen state and LayoutGallery render
5. SectionDrawer.tsx LayoutPicker has onOpenGallery button
6. wiki-data.ts has layout-gallery feature entry
7. Gallery renders all 13 standard + 5 custom layouts as scaled preview cards
8. Clicking "Créer variante" triggers a prompt and calls /api/generate-layout
9. "Appliquer" button in gallery calls onSelectRole callback
</verification>

<success_criteria>
- Gallery modal displays all existing layouts with working scaled previews
- Both entry points (wiki, SectionDrawer) open the gallery
- Variant creation works end-to-end via existing generate-layout API
- Layout selection from gallery propagates to section role change
- Wiki updated with Layout Gallery documentation
- Zero TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/10-layout-gallery-variants/10-01-SUMMARY.md`
</output>
