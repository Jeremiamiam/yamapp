---
phase: 09-retroplanning-ia
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/features/clients/components/sections/RetroplanningSection.tsx
  - src/features/clients/components/RetroplanningGantt.tsx
  - src/features/clients/components/RetroplanningTaskForm.tsx
  - src/features/clients/components/sections/index.ts
  - src/features/clients/components/ClientDetail.tsx
autonomous: true
requirements:
  - RETRO-06
  - RETRO-07
  - RETRO-08

must_haves:
  truths:
    - "L'utilisateur voit une section Retroplanning dans la fiche client"
    - "L'utilisateur peut generer un retroplanning en cliquant un bouton (si brief existe)"
    - "L'utilisateur voit un Gantt avec des barres horizontales colorees par etape"
    - "L'utilisateur peut drag-move et resize les barres du Gantt pour ajuster les dates"
    - "L'utilisateur peut cliquer une barre pour editer la tache dans un formulaire"
    - "Les modifications sont persistees en base via le store"
  artifacts:
    - path: "src/features/clients/components/sections/RetroplanningSection.tsx"
      provides: "Section wrapper with generate button, deadline input, empty state"
      min_lines: 80
    - path: "src/features/clients/components/RetroplanningGantt.tsx"
      provides: "CSS Grid Gantt chart with drag-move and resize via pointer events"
      min_lines: 120
    - path: "src/features/clients/components/RetroplanningTaskForm.tsx"
      provides: "Edit form for a single retroplanning task (label, dates, duration, color)"
      min_lines: 50
    - path: "src/features/clients/components/ClientDetail.tsx"
      provides: "RetroplanningSection integrated as full-width row"
      contains: "RetroplanningSection"
  key_links:
    - from: "src/features/clients/components/sections/RetroplanningSection.tsx"
      to: "/api/retroplanning"
      via: "fetch POST on generate button click"
      pattern: "fetch.*api/retroplanning"
    - from: "src/features/clients/components/sections/RetroplanningSection.tsx"
      to: "src/lib/store/slices/data.slice.ts"
      via: "saveRetroplanning after AI response or after edit"
      pattern: "saveRetroplanning"
    - from: "src/features/clients/components/RetroplanningGantt.tsx"
      to: "pointer events"
      via: "onPointerDown/Move/Up for drag and resize"
      pattern: "onPointerDown"
    - from: "src/features/clients/components/ClientDetail.tsx"
      to: "src/features/clients/components/sections/RetroplanningSection.tsx"
      via: "import and render"
      pattern: "RetroplanningSection"
---

<objective>
Build the complete Gantt UI for retroplanning: the section component (generate button, deadline input, empty state), the CSS Grid Gantt chart with drag-move and resize, the task edit form, and wire everything into the client detail view.

Purpose: Transforms the data layer from Plan 01 into a visual, interactive retroplanning tool embedded in each client's detail page.
Output: Working retroplanning feature visible in the client detail view.
</objective>

<execution_context>
@/Users/jeremyhervo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jeremyhervo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-retroplanning-ia/09-RESEARCH.md
@.planning/phases/09-retroplanning-ia/09-01-SUMMARY.md

@src/features/clients/components/ClientDetail.tsx
@src/features/clients/components/sections/index.ts
@src/features/clients/components/sections/DeliverablesSection.tsx
@src/types/index.ts
@src/lib/store/types.ts
@src/lib/retroplanning-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RetroplanningSection + RetroplanningGantt + RetroplanningTaskForm</name>
  <files>
    src/features/clients/components/sections/RetroplanningSection.tsx
    src/features/clients/components/RetroplanningGantt.tsx
    src/features/clients/components/RetroplanningTaskForm.tsx
    src/features/clients/components/sections/index.ts
  </files>
  <action>
**1. Create `RetroplanningSection.tsx` in `src/features/clients/components/sections/`:**

Props: `{ clientId: string }`.

This is the main container. Behavior:
- On mount, call `loadRetroplanning(clientId)` from the store.
- Read `plan = getRetroplanningByClientId(clientId)`.
- Read client's documents via `getClientById(clientId)` to check if brief content exists.
- State: `deadline` (string, date input), `isGenerating` (boolean), `editingTask` (RetroplanningTask | null).

**Empty state (no plan, no brief):** Show message "Ajoutez un brief d'abord" with muted text. No generate button.

**Empty state (no plan, has brief):** Show a date input for deadline and a "Generer le retroplanning" button (styled with `var(--accent-amber)` background). When clicked:
- Extract brief content from client documents: filter by type `web-brief`, `brief`, `report`, `creative-strategy`. Concatenate with type headers, truncate to 6000 chars. For `web-brief` type documents, if content is JSON, extract only `architecture.site_type`, `architecture.primary_objective`, `architecture.target_visitor`, and homepage section `role` + `intent` (not full content). For plain text docs, use first 4000 chars.
- POST to `/api/retroplanning` with `{ briefContent, deadline, clientName: client.name }`.
- On success, call `saveRetroplanning(clientId, { clientId, deadline, tasks: response.tasks, generatedAt: new Date().toISOString(), updatedAt: new Date().toISOString() })`.
- Show loading spinner during generation.

**Has plan:** Show the deadline in a header bar. Below, render `<RetroplanningGantt>` with the plan's tasks. Provide "Regenerer" button to regenerate (overwrites). Provide "Supprimer" button to delete (`deleteRetroplanning`).

When `editingTask` is set, render `<RetroplanningTaskForm>` as an inline panel below the Gantt (not a modal).

**Section header style:** Follow the pattern from other sections (e.g., DeliverablesSection): section title "Retroplanning" with an icon (Calendar/Gantt icon as inline SVG), accent color `var(--accent-amber)`.

**2. Create `RetroplanningGantt.tsx` in `src/features/clients/components/`:**

Props: `{ tasks: RetroplanningTask[], deadline: string, onTaskUpdate: (task: RetroplanningTask) => void, onTaskClick: (task: RetroplanningTask) => void }`.

This is a custom CSS Grid Gantt chart. Implementation:

- Compute `projectStart` = earliest task startDate. `projectEnd` = deadline.
- Compute `totalDays = daysBetween(projectStart, projectEnd)` (from retroplanning-utils).
- CSS Grid: `gridTemplateColumns: repeat(totalDays, 1fr)`. Each column = 1 day.
- Left labels column: task labels (fixed width, e.g., 180px). Grid for bars is the remaining width.
- Each task row: a `GanttBar` div positioned with `gridColumn: colStart / colEnd`.
  - `colStart = daysBetween(projectStart, task.startDate) + 1`
  - `colEnd = daysBetween(projectStart, task.endDate) + 2` (CSS grid is 1-based, exclusive end)
- Bar color: use `COLOR_MAP[task.color]` â†’ `var(--accent-{color})` with 30% opacity background and full color for the left border (4px solid).
- Bar height: `h-9`, rounded corners, flex items-center, truncated label text, small text.

**Drag-move (whole bar):**
- `onPointerDown` on bar â†’ capture pointer with `e.currentTarget.setPointerCapture(e.pointerId)`.
- Track `startX`, initial `colStart`, mode = 'move'.
- `onPointerMove` â†’ compute deltaX in pixels, convert to delta days using `containerWidth / totalDays` as pixels-per-day. Shift both startDate and endDate by delta days. Preview the shift visually.
- `onPointerUp` â†’ release capture, call `onTaskUpdate` with new dates.

**Resize-right (change endDate / duration):**
- A thin handle (6px wide, `cursor-ew-resize`) on the right edge of each bar.
- `onPointerDown` with `e.stopPropagation()` â†’ same pointer capture pattern, mode = 'resize'.
- `onPointerMove` â†’ compute delta days, adjust `endDate` and `durationDays` (minimum 1 day).
- `onPointerUp` â†’ call `onTaskUpdate`.

**Time axis header:** Show month labels and day ticks (every 7 days show a vertical line). Use lighter grid lines (`var(--border-subtle)`).

**Click:** `onClick` on bar (if no drag occurred) â†’ call `onTaskClick`.

**Today indicator:** If today falls within the project range, show a vertical red line at today's position.

**3. Create `RetroplanningTaskForm.tsx` in `src/features/clients/components/`:**

Props: `{ task: RetroplanningTask, onSave: (updated: RetroplanningTask) => void, onClose: () => void }`.

A small inline form (not modal) with:
- Input for `label` (text).
- Input for `startDate` (date).
- Input for `endDate` (date).
- Readonly display of `durationDays` (auto-computed from dates).
- Color selector: 6 buttons, one per accent color, with visual selection indicator.
- "Enregistrer" button (calls onSave) and "Annuler" button (calls onClose).

When user changes startDate or endDate, recompute durationDays = daysBetween(startDate, endDate).

Style: dark card with `bg-[var(--bg-secondary)]`, border, padding, consistent with existing forms.

**4. Update `src/features/clients/components/sections/index.ts`:**

Add export: `export { RetroplanningSection } from './RetroplanningSection';`
  </action>
  <verify>
Run `npx tsc --noEmit` â€” no type errors. Start dev server (`npm run dev`), navigate to a client detail page that has a web-brief document. Verify the Retroplanning section appears. Enter a deadline date and click "Generer". Verify Gantt bars appear. Try dragging a bar and resizing. Try clicking a bar to open the edit form.
  </verify>
  <done>
RetroplanningSection shows in client detail. Generate button calls AI and displays Gantt. Bars are draggable (move) and resizable (right edge). Clicking a bar opens inline edit form. Form saves changes to store and Supabase.
  </done>
</task>

<task type="auto">
  <name>Task 2: ClientDetail integration + wiki update</name>
  <files>
    src/features/clients/components/ClientDetail.tsx
    src/features/wiki/wiki-data.ts
  </files>
  <action>
**1. Update `src/features/clients/components/ClientDetail.tsx`:**

- Import `RetroplanningSection` from `./sections`.
- Add a full-width row BELOW the existing 3-column grid (after the closing `</div>` of the grid div), still inside the `max-w-5xl` container:

```tsx
{/* Retroplanning â€” full width below the grid */}
<div className="mt-6">
  <RetroplanningSection clientId={client.id} />
</div>
```

This places the retroplanning below contacts/links/docs and deliverables, spanning the full width. The Gantt needs horizontal space, so full-width is correct.

**2. Update `src/features/wiki/wiki-data.ts`:**

Per CLAUDE.md instructions:

- Add a new entry in `FEATURE_SECTIONS`:
```typescript
{
  id: 'retroplanning',
  title: 'Retroplanning IA',
  color: 'var(--accent-amber)',
  icon: 'calendar',
  description: "Generation automatique de retroplanning a partir du brief client. L'IA analyse le projet et propose un planning inverse depuis la deadline.",
  actions: [
    'Generer un retroplanning a partir du brief',
    'Visualiser le Gantt avec barres horizontales',
    'Drag & drop pour deplacer/redimensionner les etapes',
    'Editer les details d\'une etape (formulaire)',
    'Supprimer et regenerer le retroplanning'
  ]
}
```

- Add a new `RETROPLANNING_AGENTS` array (or add to existing agent arrays):
```typescript
{ name: 'Architecte Retroplanning', role: "Analyse le brief client et genere un planning inverse avec etapes adaptees au type de projet", color: 'var(--accent-amber)', emoji: 'ðŸ“…' }
```

- Add a pipeline step in `PIPELINE_STEPS`:
```typescript
{ emoji: 'ðŸ“…', label: 'Retroplanning', sub: 'Planning inverse IA', color: 'var(--accent-amber)' }
```

Check the exact array names and structure in wiki-data.ts before adding. Follow the existing patterns exactly.
  </action>
  <verify>
Run `npx tsc --noEmit` â€” no type errors. Navigate to a client detail page â€” RetroplanningSection visible below the main grid. Navigate to wiki view â€” Retroplanning feature listed. Check the wiki renders without errors.
  </verify>
  <done>
RetroplanningSection is integrated in ClientDetail at full width. Wiki updated with new feature, agent, and pipeline step. No TypeScript errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Client detail page shows RetroplanningSection below the main grid
3. Generate retroplanning works end-to-end: deadline input â†’ AI call â†’ Gantt displayed
4. Gantt bars are draggable (move) and resizable (right edge) with pointer events
5. Clicking a bar opens inline edit form, saving persists to store/Supabase
6. Empty state shows "Ajoutez un brief d'abord" for clients without brief documents
7. Wiki page lists Retroplanning feature and agent
8. Design uses `var(--accent-amber)` and follows existing section patterns
</verification>

<success_criteria>
- RetroplanningSection visible in every client detail page
- AI generation creates a visual Gantt chart from brief content
- Drag-move and resize work on Gantt bars (pointer events, not @hello-pangea/dnd)
- Task edit form allows label, dates, and color changes
- All changes saved to Supabase via store
- Wiki documentation updated
- Full TypeScript compilation clean
</success_criteria>

<output>
After completion, create `.planning/phases/09-retroplanning-ia/09-02-SUMMARY.md`
</output>
