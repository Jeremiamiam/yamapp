---
phase: 12-refonte-page-client-v2
plan: 03
type: execute
wave: 2
depends_on:
  - 12-01
files_modified:
  - src/features/clients/components/ProjectDrawer.tsx
  - src/features/clients/components/ProjectDrawerProductsTab.tsx
  - src/features/clients/components/ProjectDrawerDocsTab.tsx
  - src/features/clients/components/ProjectDrawerBillingTab.tsx
autonomous: true
requirements:
  - CLV2-03
  - CLV2-04
  - CLV2-10

must_haves:
  truths:
    - "Clic projet ouvre un drawer glissant depuis la droite"
    - "Drawer a 3 onglets : Produits (defaut), Docs, Facturation"
    - "Onglet Produits affiche master-detail 1/3 liste + 2/3 detail"
    - "Premier produit auto-selectionne a l'ouverture"
    - "Header drawer affiche nom projet + budget total + badge statut"
    - "Fermeture par bouton X, clic overlay, touche Echap"
    - "Onglet Docs filtre documents par projectId"
    - "Onglet Facturation affiche devis/acompte/avancements/solde hybride"
  artifacts:
    - path: "src/features/clients/components/ProjectDrawer.tsx"
      provides: "Drawer shell with tabs, overlay, keyboard close"
      min_lines: 80
    - path: "src/features/clients/components/ProjectDrawerProductsTab.tsx"
      provides: "Master-detail products view"
      min_lines: 60
    - path: "src/features/clients/components/ProjectDrawerDocsTab.tsx"
      provides: "Project documents filtered list"
      min_lines: 30
    - path: "src/features/clients/components/ProjectDrawerBillingTab.tsx"
      provides: "Hybrid billing view (project + product level)"
      min_lines: 60
  key_links:
    - from: "src/features/clients/components/ProjectDrawer.tsx"
      to: "src/features/clients/components/ProjectDrawerProductsTab.tsx"
      via: "import and render when activeTab === produits"
      pattern: "ProjectDrawerProductsTab"
    - from: "src/features/clients/components/ProjectDrawerBillingTab.tsx"
      to: "src/lib/project-billing.ts"
      via: "import computeProjectBilling for billing display"
      pattern: "computeProjectBilling"
---

<objective>
Create the ProjectDrawer component with 3 tabs (Produits, Docs, Facturation) that slides in from the right when a project is selected. Includes overlay, keyboard close, and auto-selection of first product.

Purpose: Replace ProjectModal with a contextual drawer that keeps the client page visible in the background per user decisions.
Output: 4 new components — ProjectDrawer shell + 3 tab content components.
</objective>

<execution_context>
@/Users/jeremyhervo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jeremyhervo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-refonte-page-client-v2-sidebar-client-fixe-drawer-projet-distinction-docs-client-projet-import-plaud-double-acc-s-retroplanning-footer/12-RESEARCH.md
@.planning/phases/12-refonte-page-client-v2-sidebar-client-fixe-drawer-projet-distinction-docs-client-projet-import-plaud-double-acc-s-retroplanning-footer/12-01-SUMMARY.md

@src/app/proto/client-detail-v2/page.tsx
@src/features/production/components/ProjectModal.tsx
@src/lib/project-billing.ts
@src/types/index.ts
@src/lib/store/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ProjectDrawer shell with tabs, overlay, and keyboard navigation</name>
  <files>
    src/features/clients/components/ProjectDrawer.tsx
  </files>
  <action>
    Create `ProjectDrawer.tsx` — the main drawer shell component.

    Props:
    ```tsx
    interface ProjectDrawerProps {
      project: Project;
      client: Client;
      onClose: () => void;
    }
    ```

    **Layout structure** (per research Pattern 2):
    ```tsx
    <>
      {/* Overlay semi-transparent cliquable */}
      <div
        className="absolute inset-0 bg-black/40 z-10 transition-opacity"
        onClick={onClose}
      />
      {/* Drawer */}
      <div className="absolute inset-y-0 right-0 z-20 w-[600px] max-w-[90vw]
                      bg-[var(--bg-primary)] border-l-2 border-l-[var(--accent-cyan)]
                      flex flex-col transform transition-transform duration-200 ease-out">
        {/* Header permanent */}
        <div className="flex-shrink-0 flex items-center justify-between px-4 py-3
                        border-b border-[var(--border-subtle)] bg-[var(--bg-secondary)]/50">
          <div>
            <h2 className="text-sm font-semibold text-[var(--text-primary)]">{project.name}</h2>
            {/* Budget total from computeProjectBilling */}
            {/* Badge statut facturation */}
          </div>
          <button onClick={onClose} className="text-[var(--text-secondary)] hover:text-[var(--text-primary)]">
            X icon (use project's icon pattern or simple text)
          </button>
        </div>

        {/* Tabs: Produits | Docs | Facturation */}
        <div className="flex-shrink-0 flex border-b border-[var(--border-subtle)]">
          {/* 3 tab buttons with border-b-2 active indicator (existing project pattern) */}
        </div>

        {/* Tab content */}
        <div className="flex-1 overflow-auto">
          {activeTab === 'produits' && <ProjectDrawerProductsTab ... />}
          {activeTab === 'docs' && <ProjectDrawerDocsTab ... />}
          {activeTab === 'facturation' && <ProjectDrawerBillingTab ... />}
        </div>
      </div>
    </>
    ```

    **State:**
    - `activeTab: 'produits' | 'docs' | 'facturation'` — defaults to 'produits'
    - `selectedProductId: string | null` — auto-select first product

    **Keyboard close** (per user decision):
    ```tsx
    useEffect(() => {
      const handler = (e: KeyboardEvent) => {
        if (e.key === 'Escape') onClose();
      };
      window.addEventListener('keydown', handler);
      return () => window.removeEventListener('keydown', handler);
    }, [onClose]);
    ```

    **Reset state on project change** (per research Pitfall 3):
    Use `project.id` as dependency — when project changes, reset activeTab to 'produits' and auto-select first product.

    **Billing badge in header:** Use `computeProjectBilling(project, deliverables)` from `src/lib/project-billing.ts`. Display total budget and a simple colored badge (e.g., green "Soldé", amber "En cours", red "Devis"). Exact badge design at Claude's discretion.

    Tab style: follow existing pattern from `ProjectModal.tsx` — buttons with `border-b-2` for active state, `border-transparent` for inactive.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Component exports ProjectDrawer
    - Escape key handler registered in useEffect
    - Tab state resets when project.id changes
  </verify>
  <done>
    ProjectDrawer renders with overlay, header (name + budget + badge), 3 tabs, keyboard close, and state reset on project change.
  </done>
</task>

<task type="auto">
  <name>Task 2: Three tab content components (Products, Docs, Billing)</name>
  <files>
    src/features/clients/components/ProjectDrawerProductsTab.tsx
    src/features/clients/components/ProjectDrawerDocsTab.tsx
    src/features/clients/components/ProjectDrawerBillingTab.tsx
  </files>
  <action>
    **ProjectDrawerProductsTab.tsx** — Master-detail per user decision (1/3 liste + 2/3 detail).

    Props: `{ project: Project, client: Client, selectedProductId: string | null, onSelectProduct: (id: string) => void }`

    - Get deliverables from store: `client.deliverables.filter(d => d.projectId === project.id)`
    - Left pane (1/3): list of product names, clickable. Active product highlighted with accent border.
    - Right pane (2/3): selected product detail — name, status, assignee, dates, notes, prix facturé, cout sous-traitance. Reuse field rendering from proto V2 `ProductDetailView`.
    - If no products: empty state "Aucun produit dans ce projet"
    - Auto-selection of first product handled by parent (ProjectDrawer)

    Layout: `<div className="flex h-full"><div className="w-1/3 border-r ...">list</div><div className="w-2/3 ...">detail</div></div>`

    **ProjectDrawerDocsTab.tsx** — Project documents filtered + PLAUD import button.

    Props: `{ project: Project, client: Client }`

    - Filter: `client.documents.filter(d => d.projectId === project.id)`
    - Display: titre + badge type coloré (same compact style as sidebar)
    - Button "Import PLAUD" → `setActiveModal({ type: 'report-upload', clientId: client.id, projectId: project.id })` (per user decision: creates doc projet)
    - If no docs: empty state "Aucun document — Importez un rapport PLAUD"

    **ProjectDrawerBillingTab.tsx** — Hybrid billing (project + product level).

    Props: `{ project: Project, client: Client }`

    - Use `computeProjectBilling(project, client.deliverables)` for project-level billing
    - Display two sections per user decision:
      1. **Niveau Projet** (if project has quoteAmount): Devis + Acompte + Solde restant. Each: montant + date. Format amounts as currency (EUR).
      2. **Niveau Produits**: List each product with its billing status (devis, acompte, avancements array, solde). Per user decision: "Avancements = factures produits individuelles".
    - Handle both cases: with project devis (show project-level + product avancements) and without project devis (show only product-level billing).
    - Per user decision: "chaque mouvement = montant + date uniquement" — no paid/sent status.
    - Solde calculation for project: `quoteAmount - depositAmount - sum(product invoices)`

    Reuse billing display patterns from proto V2 `computeMockProjectBilling` and `ProjectModal.tsx` billing tab.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All 3 tab components export correctly
    - ProductsTab uses 1/3 + 2/3 grid layout
    - DocsTab filters by `d.projectId === project.id`
    - BillingTab handles both with-quote and without-quote cases
  </verify>
  <done>
    ProductsTab shows master-detail with product list + detail. DocsTab shows filtered project docs + PLAUD import. BillingTab shows hybrid billing with project and product levels.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` — no type errors
- ProjectDrawer renders with overlay, closes on Escape, closes on overlay click
- Produits tab shows master-detail layout
- Docs tab shows only project documents
- Billing tab shows hybrid billing (project level + product level)
- First product auto-selected on drawer open
</verification>

<success_criteria>
ProjectDrawer fully functional with 3 tabs. Closes via X button, overlay click, and Escape key. Products tab is master-detail 1/3+2/3. Docs tab filters by projectId. Billing tab handles both billing models (with/without project quote). State resets cleanly between projects.
</success_criteria>

<output>
After completion, create `.planning/phases/12-refonte-page-client-v2-sidebar-client-fixe-drawer-projet-distinction-docs-client-projet-import-plaud-double-acc-s-retroplanning-footer/12-03-SUMMARY.md`
</output>
