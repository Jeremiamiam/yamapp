---
phase: 12-refonte-page-client-v2
plan: 04
type: execute
wave: 3
depends_on:
  - 12-02
  - 12-03
files_modified:
  - src/features/clients/components/ClientDetailV2.tsx
  - src/features/clients/components/ReportUploadModal.tsx
  - src/features/clients/components/sections/ProjectsListSection.tsx
autonomous: false
requirements:
  - CLV2-05
  - CLV2-06
  - CLV2-08

must_haves:
  truths:
    - "ProjectDrawer s'ouvre au clic sur un projet dans la liste"
    - "Import PLAUD depuis sidebar client cree un doc client (sans projectId)"
    - "Import PLAUD depuis drawer projet cree un doc projet (avec projectId)"
    - "Produits orphelins affiches dans un groupe Divers dans la liste projets"
    - "La page complete fonctionne de bout en bout (sidebar + projets + drawer + footer)"
  artifacts:
    - path: "src/features/clients/components/ClientDetailV2.tsx"
      provides: "Full wiring: sidebar + projects + drawer + footer"
      contains: "ProjectDrawer"
    - path: "src/features/clients/components/ReportUploadModal.tsx"
      provides: "PLAUD modal with optional projectId"
      contains: "projectId"
  key_links:
    - from: "src/features/clients/components/ClientDetailV2.tsx"
      to: "src/features/clients/components/ProjectDrawer.tsx"
      via: "render when selectedProjectId is set"
      pattern: "selectedProjectId.*ProjectDrawer"
    - from: "src/features/clients/components/ReportUploadModal.tsx"
      to: "src/lib/store/actions/clients.ts"
      via: "addDocument with optional projectId"
      pattern: "addDocument.*projectId"
---

<objective>
Wire everything together: integrate ProjectDrawer into ClientDetailV2, enable PLAUD double entry (sidebar client vs drawer projet), handle orphan products with Divers group, and verify the complete flow.

Purpose: Final integration and wiring — connects all Plan 02 and Plan 03 components into a working whole.
Output: Fully functional client V2 page with all features connected.
</objective>

<execution_context>
@/Users/jeremyhervo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jeremyhervo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-refonte-page-client-v2-sidebar-client-fixe-drawer-projet-distinction-docs-client-projet-import-plaud-double-acc-s-retroplanning-footer/12-RESEARCH.md
@.planning/phases/12-refonte-page-client-v2-sidebar-client-fixe-drawer-projet-distinction-docs-client-projet-import-plaud-double-acc-s-retroplanning-footer/12-01-SUMMARY.md
@.planning/phases/12-refonte-page-client-v2-sidebar-client-fixe-drawer-projet-distinction-docs-client-projet-import-plaud-double-acc-s-retroplanning-footer/12-02-SUMMARY.md
@.planning/phases/12-refonte-page-client-v2-sidebar-client-fixe-drawer-projet-distinction-docs-client-projet-import-plaud-double-acc-s-retroplanning-footer/12-03-SUMMARY.md

@src/features/clients/components/ClientDetailV2.tsx
@src/features/clients/components/ProjectDrawer.tsx
@src/features/clients/components/ReportUploadModal.tsx
@src/features/clients/components/sections/ProjectsListSection.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire ProjectDrawer into ClientDetailV2 + ReportUploadModal projectId + Orphan products</name>
  <files>
    src/features/clients/components/ClientDetailV2.tsx
    src/features/clients/components/ReportUploadModal.tsx
    src/features/clients/components/sections/ProjectsListSection.tsx
  </files>
  <action>
    **ClientDetailV2.tsx integration:**

    1. Import `ProjectDrawer` from `./ProjectDrawer`
    2. In the `<main>` zone, after the dimmed ProjectsListSection, add the ProjectDrawer conditional render:
       ```tsx
       {selectedProjectId && selectedProject && (
         <ProjectDrawer
           project={selectedProject}
           client={client}
           onClose={() => setSelectedProjectId(null)}
         />
       )}
       ```
    3. Derive `selectedProject` from the projects list: `const selectedProject = clientProjects.find(p => p.id === selectedProjectId) ?? null`
    4. Breadcrumb: update to show project name when drawer is open. When closed: "Client > Projets". When open: "Client > Projets > {project.name}". Make breadcrumb items clickable — clicking "Projets" closes the drawer.

    **ReportUploadModal.tsx modification:**

    1. Read `projectId` from `activeModal`: `const projectId = activeModal?.type === 'report-upload' ? activeModal.projectId : undefined`
    2. Pass `projectId` to the `addDocument` store call as the third argument.
    3. This means: PLAUD from sidebar (no projectId in modal) → doc client. PLAUD from drawer (projectId in modal) → doc projet.
    4. No UI change needed in the modal itself — the context (client vs project) is determined by the caller.

    **ProjectsListSection.tsx — Orphan products group:**

    1. Detect orphan deliverables: `const orphans = client.deliverables.filter(d => !d.projectId)`
    2. If orphans exist and no "Divers" project exists for this client, show a "Divers" group at the bottom of the projects list:
       - Style: same card style but with dashed border and muted colors
       - Show count of orphan products
       - Clickable → opens drawer with a virtual/synthetic "Divers" project (or create a real one)
    3. Per user decision, the "Divers" project should be auto-created in DB. Implementation at Claude's discretion:
       - **Approach:** When orphans are detected AND no project named "Divers" exists for the client, call `addProject` store action to create it with name "Divers" and clientId. Then move orphan deliverables to this project via `updateDeliverable(d.id, { projectId: diversProject.id })`.
       - Guard: only auto-create once (check `projects.find(p => p.name === 'Divers' && p.clientId === client.id)`).
       - Trigger: on component mount or when orphans detected. Use useEffect with proper deps.
       - If auto-creation fails or is too complex, fallback to showing orphans as a virtual group without DB persistence (simpler, still usable).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - ProjectDrawer renders when a project is clicked
    - Drawer closes on X, overlay click, Escape
    - Breadcrumb updates with project name
    - ReportUploadModal reads projectId from activeModal
  </verify>
  <done>
    ProjectDrawer wired into ClientDetailV2 and opens on project click. ReportUploadModal passes projectId to addDocument for PLAUD double entry. Orphan products handled via Divers group.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete client V2 page</name>
  <files>src/features/clients/components/ClientDetailV2.tsx</files>
  <action>
    Human verification of the complete client V2 page. All code was automated in prior tasks.
    What was built:
    - Sidebar fixe (contacts, liens, documents client)
    - Zone principale (liste projets)
    - ProjectDrawer (3 onglets: Produits master-detail, Docs, Facturation)
    - Footer retroplanning
    - PLAUD double entry (sidebar = doc client, drawer = doc projet)
    - Breadcrumb navigation
  </action>
  <verify>
    1. Open any client detail page in the app
    2. Verify sidebar is fixed on the left with contacts, liens, and documents (client only, not project docs)
    3. Verify projects list in the main area with project cards
    4. Click a project card — drawer should slide in from the right
    5. In the drawer, verify:
       a. Header shows project name + budget
       b. Produits tab shows master-detail (list left, detail right)
       c. First product auto-selected
       d. Docs tab shows only project documents
       e. Facturation tab shows billing breakdown
    6. Close drawer via X button, overlay click, and Escape key
    7. Verify breadcrumb updates when drawer opens/closes
    8. Verify retroplanning visible in footer at all times
    9. Test PLAUD import from sidebar — should create client doc (no projectId)
    10. Test PLAUD import from drawer Docs tab — should create project doc (with projectId)
  </verify>
  <done>User confirms the complete client V2 page works correctly: layout, drawer, tabs, PLAUD, retroplanning, breadcrumb.</done>
</task>

</tasks>

<verification>
- Full page renders without errors
- Sidebar + main + drawer + footer layout correct
- ProjectDrawer opens/closes correctly via all 3 methods
- Tabs work (Produits, Docs, Facturation)
- PLAUD double entry creates correct document context
- Breadcrumb navigation works
- Orphan products handled
</verification>

<success_criteria>
The complete client V2 page is fully functional: sidebar with contacts/liens/docs, projects list, ProjectDrawer with 3 tabs, retroplanning footer, PLAUD double entry, breadcrumb navigation, and orphan product handling. User can navigate the full hierarchy (Client > Projets > Projet > Produits > Produit) without page transitions.
</success_criteria>

<output>
After completion, create `.planning/phases/12-refonte-page-client-v2-sidebar-client-fixe-drawer-projet-distinction-docs-client-projet-import-plaud-double-acc-s-retroplanning-footer/12-04-SUMMARY.md`
</output>
