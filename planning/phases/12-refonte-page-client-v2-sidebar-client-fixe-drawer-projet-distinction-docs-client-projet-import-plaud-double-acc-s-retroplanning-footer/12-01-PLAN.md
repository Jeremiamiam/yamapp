---
phase: 12-refonte-page-client-v2
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260222210000_add_project_id_to_documents.sql
  - src/types/index.ts
  - src/lib/supabase-mappers.ts
  - src/lib/store/types.ts
  - src/lib/store/actions/clients.ts
autonomous: true
requirements:
  - CLV2-02

must_haves:
  truths:
    - "Documents table has project_id column in Supabase"
    - "ClientDocument type has optional projectId field"
    - "addDocument store action accepts optional projectId parameter"
    - "Documents loaded from Supabase include projectId mapping"
  artifacts:
    - path: "supabase/migrations/20260222210000_add_project_id_to_documents.sql"
      provides: "project_id column on documents table"
      contains: "ADD COLUMN"
    - path: "src/types/index.ts"
      provides: "ClientDocument.projectId optional field"
      contains: "projectId?"
    - path: "src/lib/supabase-mappers.ts"
      provides: "DocumentRow.project_id mapping"
      contains: "project_id"
  key_links:
    - from: "src/lib/supabase-mappers.ts"
      to: "src/types/index.ts"
      via: "mapDocumentRow maps project_id to projectId"
      pattern: "projectId.*project_id"
    - from: "src/lib/store/actions/clients.ts"
      to: "supabase documents table"
      via: "addDocument inserts project_id"
      pattern: "project_id.*projectId"
---

<objective>
Add project_id column to documents table and wire it through the entire data layer (types, mappers, store actions) to support the client vs project document distinction.

Purpose: Foundation data layer for Phase 12 — all UI plans depend on documents having a projectId field.
Output: Migration SQL, updated types, updated mappers, updated store action.
</objective>

<execution_context>
@/Users/jeremyhervo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jeremyhervo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-refonte-page-client-v2-sidebar-client-fixe-drawer-projet-distinction-docs-client-projet-import-plaud-double-acc-s-retroplanning-footer/12-RESEARCH.md

@src/types/index.ts
@src/lib/supabase-mappers.ts
@src/lib/store/types.ts
@src/lib/store/actions/clients.ts
@supabase/migrations/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Supabase migration + TypeScript types for document project_id</name>
  <files>
    supabase/migrations/20260222210000_add_project_id_to_documents.sql
    src/types/index.ts
    src/lib/supabase-mappers.ts
  </files>
  <action>
    1. Create migration file `supabase/migrations/20260222210000_add_project_id_to_documents.sql`:
       ```sql
       ALTER TABLE public.documents
         ADD COLUMN IF NOT EXISTS project_id text
         REFERENCES public.projects(id) ON DELETE SET NULL;
       ```
       No index needed (low volume). No backfill needed (existing docs stay NULL = client docs).

    2. In `src/types/index.ts`, add `projectId?: string` to the `ClientDocument` interface.
       Position: after `content: string` line. Comment: `// undefined = doc client, string = doc projet`

    3. In `src/lib/supabase-mappers.ts`:
       - Add `project_id?: string | null` to the `DocumentRow` interface (or inline type)
       - In `mapDocumentRow`, add: `projectId: row.project_id ?? undefined`
       - In `toSupabaseDocument` (or the insert mapping), add: `project_id: doc.projectId ?? null`
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no errors
    - Migration file exists and has valid SQL syntax
    - Grep confirms `projectId` in ClientDocument type and `project_id` in DocumentRow
  </verify>
  <done>
    ClientDocument has projectId field, DocumentRow maps project_id, migration ready to apply.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend store addDocument + ModalType for project context</name>
  <files>
    src/lib/store/actions/clients.ts
    src/lib/store/types.ts
  </files>
  <action>
    1. In `src/lib/store/types.ts`:
       - Find the ModalType union member `{ type: 'report-upload'; clientId: string }`
       - Extend it to `{ type: 'report-upload'; clientId: string; projectId?: string }`
       This allows ReportUploadModal to know which project (if any) the PLAUD import targets.

    2. In `src/lib/store/actions/clients.ts`:
       - Find the `addDocument` function signature. It currently takes `(clientId: string, docData: ...)`.
       - Add optional third parameter: `projectId?: string`
       - In the Supabase insert call, add `project_id: projectId ?? null` to the insert payload
       - Also update the local state push to include `projectId` in the document object

    3. Verify that `openReportUploadModal` or equivalent helper (likely in `useModal.ts` or `ui.slice.ts`) can pass the projectId. If a helper exists, extend it. If not, note that the drawer will call `setActiveModal({ type: 'report-upload', clientId, projectId })` directly.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Grep confirms `projectId` in ModalType report-upload entry
    - Grep confirms `project_id` in addDocument insert payload
  </verify>
  <done>
    Store addDocument accepts optional projectId. ModalType report-upload carries optional projectId. Data layer fully ready for UI consumption.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` — no type errors across entire project
- Migration file exists at expected path
- `ClientDocument.projectId` field accessible in types
- `addDocument(clientId, doc, projectId)` compiles with optional third argument
- ModalType `report-upload` accepts `projectId?`
</verification>

<success_criteria>
The data layer (DB schema, types, mappers, store) fully supports document-project association. All existing functionality unbroken (projectId is optional, defaults to null/undefined). UI plans can filter `client.documents` by `projectId` without any further data changes.
</success_criteria>

<output>
After completion, create `.planning/phases/12-refonte-page-client-v2-sidebar-client-fixe-drawer-projet-distinction-docs-client-projet-import-plaud-double-acc-s-retroplanning-footer/12-01-SUMMARY.md`
</output>
