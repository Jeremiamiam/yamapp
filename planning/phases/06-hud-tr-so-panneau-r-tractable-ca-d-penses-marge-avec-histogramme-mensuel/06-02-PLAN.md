---
phase: 06-compta
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/features/compta/components/ComptaView.tsx
  - src/features/compta/components/MonthlyHistogram.tsx
  - src/features/compta/components/index.ts
autonomous: false

must_haves:
  truths:
    - "User sees monthly histogram with 12 months for selected year"
    - "Green bars show completed deliverable rentrées per month"
    - "Red bars show completed deliverable sous-traitance per month"
    - "Histogram updates when year changes"
    - "Empty months show no bars (not zero-height bars)"
  artifacts:
    - path: "src/features/compta/components/MonthlyHistogram.tsx"
      provides: "Monthly bar chart component calculated from deliverable dueDate"
      exports: ["MonthlyHistogram"]
    - path: "src/features/compta/components/ComptaView.tsx"
      provides: "Complete ComptaView integrating histogram"
      contains: "MonthlyHistogram"
  key_links:
    - from: "src/features/compta/components/MonthlyHistogram.tsx"
      to: "deliverables data"
      via: "props (completedDeliverables array)"
      pattern: "completedDeliverables|monthlyData"
    - from: "src/features/compta/components/ComptaView.tsx"
      to: "src/features/compta/components/MonthlyHistogram.tsx"
      via: "import and render with props"
      pattern: "MonthlyHistogram"
---

<objective>
Add real monthly histogram to ComptaView, replacing the removed mock histogram. Calculate monthly entrees/sorties from completed deliverable dueDate, render as CSS-based bar chart with 12 months.

Purpose: Completes the Phase 6 visual experience -- the histogram provides monthly financial overview for the selected year.
Output: Working monthly histogram component integrated into ComptaView + visual verification.
</objective>

<execution_context>
@/Users/jeremyhervo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jeremyhervo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@planning/phases/06-hud-tr-so-panneau-r-tractable-ca-d-penses-marge-avec-histogramme-mensuel/06-CONTEXT.md
@planning/phases/06-hud-tr-so-panneau-r-tractable-ca-d-penses-marge-avec-histogramme-mensuel/06-RESEARCH.md
@planning/phases/06-hud-tr-so-panneau-r-tractable-ca-d-penses-marge-avec-histogramme-mensuel/06-01-SUMMARY.md

# Source files
@src/features/compta/components/ComptaView.tsx
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MonthlyHistogram component</name>
  <files>src/features/compta/components/MonthlyHistogram.tsx, src/features/compta/components/index.ts</files>
  <action>
Create `src/features/compta/components/MonthlyHistogram.tsx`:

A pure presentational component that receives completed deliverables and the selected year, computes monthly aggregation, and renders a CSS-based bar chart.

**Props interface:**
```typescript
interface MonthlyHistogramProps {
  completedDeliverables: Deliverable[];
  year: number;
}
```

**Data calculation (useMemo):**
```typescript
const monthlyData = useMemo(() => {
  const months = Array.from({ length: 12 }, (_, i) => ({
    label: new Date(year, i).toLocaleDateString('fr-FR', { month: 'short' }),
    entrées: 0,
    sorties: 0,
  }));

  for (const d of completedDeliverables) {
    if (!d.dueDate) continue;
    const monthIndex = new Date(d.dueDate).getMonth();
    months[monthIndex].entrées += d.prixFacturé ?? 0;
    months[monthIndex].sorties += d.coutSousTraitance ?? 0;
  }

  return months;
}, [completedDeliverables, year]);
```

**maxValue calculation:**
```typescript
const maxValue = useMemo(() => {
  const max = Math.max(
    ...monthlyData.map(m => Math.max(m.entrées, m.sorties)),
    1 // prevent division by zero
  );
  return max;
}, [monthlyData]);
```

**Rendering:**
- Wrap in a card: `rounded-xl border border-[var(--border-subtle)] bg-[var(--bg-card)] p-6`
- Title: "Bilan mensuel {year}" -- text-sm font-medium text-[var(--text-primary)]
- Subtitle: "Rentrées (vert) et sous-traitance (rouge) par mois" -- text-xs text-[var(--text-muted)]
- Chart container: `h-48 flex items-end gap-2 mt-6`
- For each month, render a column:
  ```tsx
  <div key={i} className="flex-1 flex flex-col items-center min-w-0 gap-1">
    <div className="w-full flex flex-col-reverse items-center gap-0.5" style={{ height: '100%' }}>
      {m.entrées > 0 && (
        <div
          className="w-full max-w-[28px] rounded-t bg-[#22c55e]/80"
          style={{ height: `${(m.entrées / maxValue) * 100}%`, minHeight: 6 }}
          title={`Entrées: ${formatEur(m.entrées)}`}
        />
      )}
      {m.sorties > 0 && (
        <div
          className="w-full max-w-[28px] rounded-t bg-[#ef4444]/80"
          style={{ height: `${(m.sorties / maxValue) * 100}%`, minHeight: 6 }}
          title={`Sorties: ${formatEur(m.sorties)}`}
        />
      )}
    </div>
    <span className="text-[10px] font-medium text-[var(--text-muted)] uppercase">
      {m.label}
    </span>
  </div>
  ```
- Include the `formatEur` helper locally:
  ```typescript
  const formatEur = (n: number) =>
    new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(n);
  ```
- Show empty state if no data for any month:
  ```tsx
  {monthlyData.every(m => m.entrées === 0 && m.sorties === 0) && (
    <p className="text-sm text-[var(--text-muted)] text-center w-full py-8">
      Aucune donnée pour {year}
    </p>
  )}
  ```
- `'use client';` directive, import useMemo from react, import Deliverable type.

**Update index.ts** to export MonthlyHistogram:
```
export { ComptaView } from './ComptaView';
export { YearSelector } from './YearSelector';
export { MonthlyHistogram } from './MonthlyHistogram';
```

No external charting library. Pure CSS height-based bars (per research: "custom SVG/div approach already working, Recharts would add 400KB+").
  </action>
  <verify>Run `npx tsc --noEmit`. No type errors. File exports MonthlyHistogram component.</verify>
  <done>MonthlyHistogram.tsx exists, receives completedDeliverables + year, computes monthly totals from dueDate, renders 12-month CSS bar chart with green (entrees) and red (sorties) bars. Hover titles show formatted amounts.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate MonthlyHistogram into ComptaView</name>
  <files>src/features/compta/components/ComptaView.tsx</files>
  <action>
Replace the histogram placeholder comment (left by Plan 06-01) with the MonthlyHistogram component.

1. Add import at top of file:
```typescript
import { MonthlyHistogram } from './MonthlyHistogram';
```

2. Find the placeholder comment `{/* Histogramme mensuel -- Plan 06-02 */}` and replace with:
```tsx
<MonthlyHistogram completedDeliverables={completedDeliverables} year={comptaYear} />
```

The `completedDeliverables` and `comptaYear` variables should already exist from Plan 06-01's rewrite.

3. If the store still imports/references `comptaMonthly`, clean up:
   - Remove `comptaMonthly` from the useAppStore destructuring if still present
   - Remove the `maxAbs` memo if it still references comptaMonthly

4. Verify the overall layout order in ComptaView JSX is:
   1. Header row (title "Bilan annuel" + YearSelector)
   2. 4 KPI cards grid
   3. "Rentrées par client" expandable table
   4. "Potentiel par client" expandable section
   5. MonthlyHistogram (NEW)

This task is intentionally small because the heavy lifting was done in Plan 06-01.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `npm run build` -- build succeeds.
Navigate to Comptabilite tab: histogram shows 12 months with bars for months that have completed deliverables.
  </verify>
  <done>MonthlyHistogram integrated into ComptaView. Shows 12-month bar chart with real data from completed deliverables. No mock comptaMonthly data used anywhere. Build passes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of complete ComptaView</name>
  <files>src/features/compta/components/ComptaView.tsx</files>
  <action>
Human verification of the complete Phase 6 ComptaView. No code changes -- visual and functional verification only.

Start the dev server with `npm run dev`, login as admin, navigate to Comptabilite tab, and verify all sections render correctly with real data.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Login as admin user
3. Navigate to "Comptabilite" tab in the Header
4. Verify:
   a. Year selector shows current year with left/right arrows
   b. Click left arrow -- year decrements, KPIs and tables update
   c. Click right arrow -- year increments back
   d. KPI "Rentrées validées" (green) shows sum of completed deliverables prixFacturé
   e. KPI "Sous-traitance" (red) shows sum of completed deliverables coutSousTraitance
   f. KPI "Marge nette" (blue) = rentrées - sous-traitance
   g. KPI "Potentiel" (amber, dashed border) shows pending/in-progress deliverables
   h. "Rentrées par client" table lists clients with expandable detail rows
   i. "Potentiel par client" section shows prospect clients with "(P)" badge
   j. Monthly histogram shows bars for months with data
   k. Changing year updates all sections including histogram
5. Test edge case: select a year with no data -- should show empty states gracefully
  </verify>
  <done>User has visually confirmed all ComptaView sections render correctly: year selector, 4 KPIs, rentrées par client, potentiel par client, monthly histogram. All data is real (not mock). Changing year updates everything.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. MonthlyHistogram renders 12 months with correct bars
4. All data uses real deliverable dueDate, not mock comptaMonthly
5. Histogram updates when year selector changes
6. Empty year shows appropriate empty state
7. Human has verified the complete visual experience
</verification>

<success_criteria>
- MonthlyHistogram component exists and renders real data
- Green bars = entrees (prixFacture of completed deliverables by month)
- Red bars = sorties (coutSousTraitance of completed deliverables by month)
- No external charting library used
- Histogram integrated into ComptaView at the bottom
- Complete ComptaView visually verified by user
- TypeScript compiles, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/06-hud-tr-so-panneau-r-tractable-ca-d-penses-marge-avec-histogramme-mensuel/06-02-SUMMARY.md`
</output>
